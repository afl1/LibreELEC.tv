From 4448618220a54a23b3a059ef202d390be685c5c3 Mon Sep 17 00:00:00 2001
From: RealJohnGalt <johngalt@fake.mail>
Date: Fri, 7 Jul 2017 00:10:03 -0700
Subject: [PATCH] VideoPlayer: @afl1 channel and chapter skip fix

---
 xbmc/cores/VideoPlayer/VideoPlayer.cpp      | 43 ++++++++++++++++++++++-------
 xbmc/cores/VideoPlayer/VideoPlayerAudio.cpp |  9 +++---
 2 files changed, 38 insertions(+), 14 deletions(-)

diff --git a/xbmc/cores/VideoPlayer/VideoPlayer.cpp b/xbmc/cores/VideoPlayer/VideoPlayer.cpp
index ce0f01a..1adf29d 100644
--- a/xbmc/cores/VideoPlayer/VideoPlayer.cpp
+++ b/xbmc/cores/VideoPlayer/VideoPlayer.cpp
@@ -1963,15 +1963,34 @@ void CVideoPlayer::HandlePlaySpeed()
       // care for live streams
       else if (m_pInputStream->IsRealtime())
       {
-        if (m_CurrentAudio.id >= 0)
+        if (m_CurrentAudio.id >= 0 && m_clock.GetClock() > DVD_MSEC_TO_TIME(0))
         {
           double adjust = -1.0; // a unique value
-          if (m_clock.GetSpeedAdjust() >= 0 && m_VideoPlayerAudio->GetLevel() < 5)
-            adjust = -0.05;
-
-          if (m_clock.GetSpeedAdjust() < 0 && m_VideoPlayerAudio->GetLevel() > 10)
+          if ( m_VideoPlayerAudio->GetLevel() > 20 && m_VideoPlayerVideo->GetLevel() < 1) {
+            CLog::Log(LOGNOTICE, "VideoPlayer:Full caching video aq:%d vq:%d", m_VideoPlayerAudio->GetLevel(), m_VideoPlayerVideo->GetLevel()); 
+            SetCaching(CACHESTATE_FULL);
+            usleep(400000);
+            SetCaching(CACHESTATE_PLAY);
+          }
+          if (m_clock.GetSpeedAdjust() < -0.05 && m_VideoPlayerAudio->GetLevel() < 1 && m_VideoPlayerVideo->GetLevel() < 3) {
+            CLog::Log(LOGNOTICE, "VideoPlayer:Full caching aq:%d vq:%d", m_VideoPlayerAudio->GetLevel(), m_VideoPlayerVideo->GetLevel());
+            SetCaching(CACHESTATE_FULL);
+            usleep(200000);
+            SetCaching(CACHESTATE_PLAY);
+          }
+          if (m_clock.GetSpeedAdjust() >= -0.05 && m_VideoPlayerAudio->GetLevel() < 1 && m_VideoPlayerVideo->GetLevel() < 3) {
+            CLog::Log(LOGNOTICE, "VideoPlayer:Prep caching aq:%d vq:%d clock:%0.3f", m_VideoPlayerAudio->GetLevel(), m_VideoPlayerVideo->GetLevel(),  m_clock.GetClock());  
+            adjust = -0.06; 
+            usleep(50000);
+          }
+          if (m_clock.GetSpeedAdjust() >= 0 && m_VideoPlayerAudio->GetLevel() < 3) {
+            CLog::Log(LOGDEBUG, "VideoPlayer:Speed adjust:-0.05 aq:%d vq:%d", m_VideoPlayerAudio->GetLevel(), m_VideoPlayerVideo->GetLevel());  
+             adjust = -0.05;
+          }
+          if (m_clock.GetSpeedAdjust() < 0 && m_VideoPlayerAudio->GetLevel() > 5) {
+            CLog::Log(LOGDEBUG, "VideoPlayer:Speed adjust:0.0 aq:%d vq:%d", m_VideoPlayerAudio->GetLevel(), m_VideoPlayerVideo->GetLevel());  
             adjust = 0.0;
-
+          }
           if (adjust != -1.0)
           {
             m_clock.SetSpeedAdjust(adjust);
@@ -2028,8 +2047,11 @@ void CVideoPlayer::HandlePlaySpeed()
       }
       else if (m_CurrentAudio.starttime != DVD_NOPTS_VALUE && m_CurrentAudio.packets > 0)
       {
-        if (m_pInputStream->IsRealtime())
-          clock = m_CurrentAudio.starttime - m_CurrentAudio.cachetotal - DVD_MSEC_TO_TIME(400);
+        if (m_pInputStream->IsRealtime()) {
+          clock = m_CurrentAudio.starttime- DVD_MSEC_TO_TIME(1000); // - m_CurrentAudio.cachetime;
+	 //  if (clock > - DVD_MSEC_TO_TIME(700)) 
+	 //    clock = - DVD_MSEC_TO_TIME(700);
+        }
         else
           clock = m_CurrentAudio.starttime - m_CurrentAudio.cachetime;
 
@@ -2616,8 +2638,9 @@ void CVideoPlayer::HandleMessages()
       // This should always be the case.
       if(m_pDemuxer && m_pDemuxer->SeekChapter(msg.GetChapter(), &start))
       {
-        FlushBuffers(start, true, true);
-        offset = DVD_TIME_TO_MSEC(start) - static_cast<int>(beforeSeek);
+        CLog::Log(LOGDEBUG, "VideoPlayer: SeekChapter:%d beforeSeek:%ld start:%ld",  msg.GetChapter(), beforeSeek, (int64_t)DVD_TIME_TO_MSEC(start)); 
+        FlushBuffers(DVD_MSEC_TO_TIME(static_cast<int>(beforeSeek)), true, true);
+        offset = static_cast<int>(beforeSeek) - DVD_TIME_TO_MSEC(start);
         m_callback.OnPlayBackSeekChapter(msg.GetChapter());
       }
 
diff --git a/xbmc/cores/VideoPlayer/VideoPlayerAudio.cpp b/xbmc/cores/VideoPlayer/VideoPlayerAudio.cpp
index 38428e2..4279440 100644
--- a/xbmc/cores/VideoPlayer/VideoPlayerAudio.cpp
+++ b/xbmc/cores/VideoPlayer/VideoPlayerAudio.cpp
@@ -293,13 +293,14 @@ void CVideoPlayerAudio::Process()
         // while AE sync is active, we still have time to fill buffers
         if (m_syncTimer.IsTimePast())
         {
-          CLog::Log(LOGNOTICE, "CVideoPlayerAudio::Process - stream stalled");
+          CLog::Log(LOGNOTICE, "CVideoPlayerAudio::Process - stream stalled timeout:%d initialTimeout:%d startTime:%d MillisLeft:%d", timeout, m_syncTimer.GetInitialTimeoutValue(), m_syncTimer.GetStartTime(), m_syncTimer.MillisLeft());
           m_stalled = true;
         }
       }
-      if (timeout == 0)
-        Sleep(10);
-
+      if (timeout == 0) {
+        CLog::Log(LOGNOTICE, "CVideoPlayerAudio::Process - sleep 0.1 sec");
+        usleep(100000);
+      }
       continue;
     }
 
-- 
2.13.0

